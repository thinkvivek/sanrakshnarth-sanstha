using System;
using System.Collections.Generic;
using System.Drawing;
using OfficeOpenXml;
using OfficeOpenXml.Style;

class Program
{
    static void Main()
    {
        // Load Excel files into ExcelPackage objects
        ExcelPackage excelPackage1 = new ExcelPackage(new System.IO.FileInfo("file1.xlsx"));
        ExcelPackage excelPackage2 = new ExcelPackage(new System.IO.FileInfo("file2.xlsx"));

        // Get worksheets from ExcelPackage objects
        ExcelWorksheet worksheet1 = excelPackage1.Workbook.Worksheets[0];
        ExcelWorksheet worksheet2 = excelPackage2.Workbook.Worksheets[0];

        // Create a new ExcelPackage for differences
        ExcelPackage differencesPackage = new ExcelPackage();
        ExcelWorksheet differencesWorksheet = differencesPackage.Workbook.Worksheets.Add("Differences");

        // Compare the two Excel sheets
        CompareExcelSheets(worksheet1, worksheet2, differencesWorksheet);

        // Save the differences Excel sheet
        differencesPackage.SaveAs(new System.IO.FileInfo("differences.xlsx"));

        Console.WriteLine("Differences saved successfully.");
    }

    static void CompareExcelSheets(ExcelWorksheet worksheet1, ExcelWorksheet worksheet2, ExcelWorksheet differencesWorksheet)
    {
        // Copy headers to differences worksheet
        for (int col = 1; col <= worksheet1.Dimension.End.Column; col++)
        {
            differencesWorksheet.Cells[1, col].Value = worksheet1.Cells[1, col].Value;
        }
        for (int col = 1; col <= worksheet2.Dimension.End.Column; col++)
        {
            differencesWorksheet.Cells[1, worksheet1.Dimension.End.Column + col].Value = worksheet2.Cells[1, col].Value;
        }

        // Initialize row index for the differences worksheet
        int differencesRowIndex = 2;

        // Compare rows
        int rowIndex1 = 2;
        int rowIndex2 = 2;
        while (true)
        {
            // Get the rows to compare
            var row1 = worksheet1.Cells[rowIndex1, 1, rowIndex1, worksheet1.Dimension.End.Column];
            var row2 = worksheet2.Cells[rowIndex2, 1, rowIndex2, worksheet2.Dimension.End.Column];

            // If one of the rows is null, we've reached the end of one of the sheets
            if (row1.Value == null && row2.Value == null)
                break;

            // Find the number of matching columns
            int matchingColumns = FindMatchingColumns(row1, row2);

            // Copy rows to differences worksheet
            if (matchingColumns == worksheet1.Dimension.End.Column) // If all columns match
            {
                CopyRowToDifferences(worksheet1, differencesWorksheet, rowIndex1, 2, differencesRowIndex, matchingColumns, Color.LightGreen);
                CopyRowToDifferences(worksheet2, differencesWorksheet, rowIndex2, worksheet1.Dimension.End.Column + 1, differencesRowIndex, matchingColumns, Color.LightGreen);
            }
            else // If not all columns match
            {
                CopyRowToDifferences(worksheet1, differencesWorksheet, rowIndex1, 2, differencesRowIndex, worksheet1.Dimension.End.Column, Color.Red);
                CopyRowToDifferences(worksheet2, differencesWorksheet, rowIndex2, worksheet1.Dimension.End.Column + 1, differencesRowIndex, worksheet2.Dimension.End.Column, Color.Red);
            }

            // Move to the next row index for the differences worksheet
            differencesRowIndex++;

            // Move to the next row index for each source worksheet
            if (row1.Value != null)
                rowIndex1++;
            if (row2.Value != null)
                rowIndex2++;
        }
    }

    static int FindMatchingColumns(ExcelRange row1, ExcelRange row2)
    {
        int matchingColumns = 0;
        for (int col = 1; col <= row1.End.Column; col++)
        {
            if (row1.GetValue(1, col).Equals(row2.GetValue(1, col)))
                matchingColumns++;
        }
        return matchingColumns;
    }

    static void CopyRowToDifferences(ExcelWorksheet sourceWorksheet, ExcelWorksheet differencesWorksheet, int sourceRowIndex, int startColumn, int destRowIndex, int endColumn, Color color)
    {
        for (int col = 1; col <= endColumn; col++)
        {
            var sourceCell = sourceWorksheet.Cells[sourceRowIndex, col];
            differencesWorksheet.Cells[destRowIndex, startColumn + col - 1].Value = sourceCell.Value;
            differencesWorksheet.Cells[destRowIndex, startColumn + col - 1].Style.Fill.PatternType = ExcelFillStyle.Solid;
            differencesWorksheet.Cells[destRowIndex, startColumn + col - 1].Style.Fill.BackgroundColor.SetColor(color);
        }
    }
}
